---
import { ClientRouter } from 'astro:transitions';
import BaseHead from '../components/BaseHead.astro';
import LeftColumn from '../components/LeftColumn.astro';
import MobileHeader from '../components/MobileHeader.astro';

import { navItems } from '../data/nav';
import '../styles/global.css';

interface SidebarContext {
  narrative?: string;
  readingTime?: string;
  wordCount?: string;
  publishDate?: string;
  tags?: string[];
}

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  publishedDate?: Date;
  noindex?: boolean;
  sidebarContext?: SidebarContext;
}

const { title, description, image, type, publishedDate, noindex, sidebarContext } = Astro.props;
const currentPath = Astro.url.pathname;

function isActive(href: string, match: 'exact' | 'prefix', path: string) {
  return match === 'exact' ? path === href : path.startsWith(href);
}
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={title}
      description={description}
      image={image}
      type={type}
      publishedDate={publishedDate}
      noindex={noindex}
    />
    <ClientRouter />
  </head>
  <body data-page={currentPath === '/' ? 'home' : 'inner'}>
    <a href="#main-content" class="skip-nav">Skip to main content</a>

    <MobileHeader />

    <div class="site">
      <div class="left-column" transition:persist="sidebar" transition:name="sidebar" transition:animate="none">
        <div class="left-column-inner">
          <LeftColumn currentPath={currentPath} sidebarContext={sidebarContext} />
        </div>
      </div>
      <div class="site-main">
        <main id="main-content">
          <slot />
        </main>
      </div>
    </div>

    {/* Sidebar context data for client-side updates during view transitions */}
    <script is:inline define:vars={{ sidebarContextJSON: JSON.stringify(sidebarContext || null) }}>
      window.__sidebarContext = JSON.parse(sidebarContextJSON);
    </script>
  </body>
</html>

<script>
  // Astro module script — runs exactly once, not re-executed on navigations.
  // Do NOT add is:inline without adding listener deduplication guards.

  function updateActiveStates(path: string) {
    document.querySelectorAll('.sidebar-link, .pyramid-link, .mobile-name').forEach((link) => {
      const href = link.getAttribute('href');
      const match = link.getAttribute('data-match');
      if (!href || !match) return;

      const isActive = match === 'exact'
        ? path === href
        : path.startsWith(href);

      link.classList.toggle('active', isActive);
      if (isActive) link.setAttribute('aria-current', 'page');
      else link.removeAttribute('aria-current');
    });
  }

  function updateSidebarContext(path: string) {
    const isHome = path === '/';
    const isBlogPost = path.startsWith('/blog/') && path !== '/blog/';
    const ctx = (window as any).__sidebarContext;

    // Toggle homepage vs inner page content
    const sidebarNav = document.querySelector('.sidebar-nav') as HTMLElement | null;
    const homeContext = document.querySelector('.sidebar-context') as HTMLElement | null;

    if (isHome) {
      // On homepage: hide nav, show homepage context
      if (sidebarNav) sidebarNav.style.display = 'none';
      if (homeContext) {
        homeContext.style.display = '';
        homeContext.innerHTML = `
          <p class="context-tagline">Building at the intersection of finance and technology.</p>
          <div class="context-tags">
            <span class="inline-tag">finance</span>
            <span class="inline-tag">technology</span>
            <span class="inline-tag">writing</span>
          </div>
          <p class="context-availability">Open to opportunities</p>
        `;
      }
    } else {
      // On inner pages: show nav, update context
      if (sidebarNav) sidebarNav.style.display = '';

      if (ctx && homeContext) {
        let html = '';
        if (isBlogPost && ctx.readingTime) {
          html += `<p class="context-meta">${ctx.readingTime} &middot; ${ctx.wordCount}</p>`;
        }
        if (isBlogPost && ctx.publishDate) {
          html += `<p class="context-meta">${ctx.publishDate}</p>`;
        }
        if (isBlogPost && ctx.tags && ctx.tags.length > 0) {
          html += `<div class="context-tags">${ctx.tags.map((t: string) => `<span class="inline-tag">${t}</span>`).join('')}</div>`;
        }
        if (!isBlogPost && ctx.narrative) {
          html += `<p class="context-narrative">${ctx.narrative}</p>`;
        }
        html += `<p class="context-availability">Open to opportunities</p>`;
        homeContext.innerHTML = html;
        homeContext.style.display = '';
      } else if (homeContext && !ctx) {
        // No context provided — show just availability
        homeContext.innerHTML = `<p class="context-availability">Open to opportunities</p>`;
      }
    }
  }

  // After view-transition swap: update persisted sidebar + scroll to hash
  document.addEventListener('astro:after-swap', () => {
    const path = window.location.pathname;
    updateActiveStates(path);
    document.body.dataset.page = path === '/' ? 'home' : 'inner';
    updateSidebarContext(path);

    // Reset sidebar scroll when navigating to homepage
    if (path === '/') {
      const sidebar = document.querySelector('.left-column');
      if (sidebar) sidebar.scrollTop = 0;
    }

    const hash = window.location.hash;
    if (!hash) return;
    try {
      const target = document.querySelector(hash);
      if (target) target.scrollIntoView({ behavior: 'instant' });
    } catch { /* hash is not a valid CSS selector, ignore */ }
  });

  // After bfcache restoration (e.g., returning from external link)
  window.addEventListener('pageshow', (event) => {
    if ((event as PageTransitionEvent).persisted) {
      const path = window.location.pathname;
      updateActiveStates(path);
      document.body.dataset.page = path === '/' ? 'home' : 'inner';
    }
  });
</script>

<style>
  /* Site grid */
  .site {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr;
    min-height: 100dvh;
  }

  /* Left column — persistent sidebar */
  .left-column {
    position: sticky;
    top: 0;
    height: 100dvh;
    align-self: start;
    z-index: 50;
    overflow-y: auto;
    overscroll-behavior: contain;
    background: var(--background);
    border-right: 1px solid var(--border);
  }

  .left-column-inner {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: clamp(1rem, 3dvh, 2rem) var(--space-lg);
  }

  /* Main content area */
  .site-main {
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    padding: var(--space-xl) var(--gutter) var(--space-lg);
  }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Ultra-wide — constrain and center */
  @media (min-width: 120em) {
    .site {
      max-width: 1920px;
      margin-inline: auto;
    }
  }

  /* View transition — prevent sidebar animation and z-index issues */
  ::view-transition-group(sidebar) {
    z-index: 100;
  }

  /* Tablet — narrower sidebar */
  @media (max-width: 1024px) and (min-width: 769px) {
    .site {
      grid-template-columns: clamp(200px, 20vw, 260px) 1fr;
    }
  }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    .site {
      grid-template-columns: 1fr;
    }

    .left-column {
      display: none;
    }

    .site-main {
      padding: var(--space-md) var(--space-md) var(--space-lg);
    }
  }

  @media (max-height: 600px) {
    .left-column-inner {
      padding: var(--space-sm) var(--space-md);
    }
  }
</style>
